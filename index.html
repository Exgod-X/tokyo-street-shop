<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TOKYO STREET | Anime Streetwear</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;700;900&family=Orbitron:wght@400;700;900&family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet">
    
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://js.stripe.com/v3/"></script>
    
    <style>
        body { 
            font-family: 'Noto Sans JP', sans-serif; 
            background-color: #0a0a0f; 
            color: #fff; 
            overflow-x: hidden; 
        }
        .fontDisplay { font-family: 'Orbitron', monospace; }
        .fontMono { font-family: 'JetBrains Mono', monospace; }
        
        /* Product Card Styling */
        .product-card { 
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); 
            background: linear-gradient(135deg, rgba(21,21,32,0.9) 0%, rgba(21,21,32,0.6) 100%); 
            backdrop-filter: blur(10px); 
            border: 1px solid rgba(255,255,255,0.05);
        }
        .product-card:hover { 
            transform: translateY(-8px) scale(1.02); 
            border-color: rgba(236, 72, 153, 0.5);
            box-shadow: 0 20px 40px rgba(236, 72, 153, 0.15);
        }
        .product-card:hover .product-image {
            transform: scale(1.05);
        }
        .product-image {
            transition: transform 0.5s ease;
        }
        
        /* Cart Sidebar */
        .cart-overlay {
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }
        .cart-overlay.open {
            opacity: 1;
            visibility: visible;
        }
        .cart-sidebar { 
            transform: translateX(100%); 
            transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1); 
        }
        .cart-sidebar.open { 
            transform: translateX(0); 
        }
        
        /* Status indicators */
        .status-dot { 
            width: 8px; 
            height: 8px; 
            border-radius: 50%; 
            display: inline-block; 
            margin-right: 6px; 
        }
        .status-online { background: #00ff41; box-shadow: 0 0 10px #00ff41; }
        .status-offline { background: #ff0033; }
        .status-local { background: #ffff00; }
        
        /* Toast notifications */
        .toast { 
            transform: translateX(120%); 
            transition: transform 0.4s cubic-bezier(0.68, -0.55, 0.265, 1.55); 
        }
        .toast.show { 
            transform: translateX(0); 
        }
        
        /* Size selector */
        .size-btn {
            transition: all 0.2s ease;
        }
        .size-btn:hover:not(.selected):not(:disabled) {
            border-color: rgba(236, 72, 153, 0.5);
            background: rgba(236, 72, 153, 0.1);
        }
        .size-btn.selected {
            border-color: #ec4899;
            background: rgba(236, 72, 153, 0.3);
            color: #fff;
        }
        .size-btn:disabled {
            opacity: 0.3;
            cursor: not-allowed;
        }
        
        /* Quantity controls */
        .qty-btn {
            transition: all 0.2s ease;
        }
        .qty-btn:hover:not(:disabled) {
            background: rgba(236, 72, 153, 0.3);
        }
        .qty-btn:disabled {
            opacity: 0.3;
            cursor: not-allowed;
        }
        
        /* Cart badge animation */
        @keyframes cartBounce {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.3); }
        }
        .cart-badge.animate {
            animation: cartBounce 0.3s ease;
        }
        
        /* Gradient text */
        .gradient-text {
            background: linear-gradient(135deg, #ec4899 0%, #06b6d4 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        /* Product quick view modal */
        .modal-overlay {
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }
        .modal-overlay.open {
            opacity: 1;
            visibility: visible;
        }
        .modal-content {
            transform: scale(0.9) translateY(20px);
            transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
        }
        .modal-overlay.open .modal-content {
            transform: scale(1) translateY(0);
        }
        
        /* Scrollbar styling */
        ::-webkit-scrollbar {
            width: 6px;
        }
        ::-webkit-scrollbar-track {
            background: rgba(255,255,255,0.05);
        }
        ::-webkit-scrollbar-thumb {
            background: rgba(236, 72, 153, 0.5);
            border-radius: 3px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: rgba(236, 72, 153, 0.8);
        }
    </style>
</head>
<body class="antialiased">

    <!-- Local Mode Banner -->
    <div id="connection-banner" class="hidden fixed top-0 w-full z-[200] bg-yellow-600 text-black p-2 text-center text-sm font-bold">
        ‚ö†Ô∏è OFFLINE MODE: Cart saved locally only
        <button onclick="location.reload()" class="ml-2 bg-black text-yellow-400 px-3 py-1 rounded text-xs hover:bg-gray-800">Reconnect</button>
    </div>

    <!-- Status Bar -->
    <div class="fixed top-0 w-full z-50 bg-black/90 border-b border-white/10 px-4 py-2 flex justify-between items-center text-xs font-mono">
        <div class="flex items-center gap-4">
            <span class="flex items-center">
                <span id="status-dot" class="status-dot status-offline"></span>
                <span id="auth-status" class="text-gray-400">CONNECTING...</span>
            </span>
        </div>
        <div class="text-gray-500 fontDisplay text-[10px] tracking-wider">TOKYO STREET SYSTEM v2.0</div>
    </div>

    <!-- Toast Container -->
    <div id="toast-container" class="fixed top-16 right-4 z-[60] flex flex-col gap-2 w-80 pointer-events-none"></div>

    <!-- ==================== AUTH MODAL ==================== -->
    <div id="auth-modal" class="fixed inset-0 z-[100] flex overflow-hidden bg-gray-900">
        <div class="hidden lg:flex lg:w-1/2 relative overflow-hidden bg-gradient-to-br from-indigo-900 via-purple-900 to-pink-800">
            <div class="absolute inset-0 opacity-20">
                <div class="absolute top-20 left-20 w-72 h-72 bg-pink-500 rounded-full filter blur-3xl"></div>
                <div class="absolute bottom-20 right-20 w-96 h-96 bg-cyan-500 rounded-full filter blur-3xl"></div>
            </div>
            <div class="relative z-10 flex flex-col justify-center px-16 text-white">
                <h1 class="text-5xl font-bold mb-6">
                    Welcome to<br/>
                    <span class="gradient-text">Tokyo Street</span>
                </h1>
                <p class="text-gray-300 text-lg mb-8">Discover exclusive anime streetwear that defines your style.</p>
                <div class="flex gap-4 text-sm">
                    <div class="flex items-center gap-2">
                        <span class="text-pink-400">‚úì</span> Premium Quality
                    </div>
                    <div class="flex items-center gap-2">
                        <span class="text-cyan-400">‚úì</span> Worldwide Shipping
                    </div>
                </div>
            </div>
        </div>

        <div class="w-full lg:w-1/2 bg-gray-950 flex flex-col justify-center px-8 relative">
            <div class="relative z-10 w-full max-w-md mx-auto">
                <div class="mb-8">
                    <h2 id="form-title" class="text-3xl font-bold text-white mb-2">Sign In</h2>
                    <p id="form-subtitle" class="text-gray-400">Welcome back! Please enter your details.</p>
                </div>

                <!-- Login Form -->
                <form id="login-form" class="space-y-6" onsubmit="event.preventDefault(); handleLogin();">
                    <div>
                        <label class="text-sm text-gray-300 block mb-1">Email</label>
                        <input type="email" id="login-email" required
                               class="w-full px-4 py-3 rounded-xl bg-white/5 border border-gray-700 text-white focus:border-pink-500 outline-none transition-all">
                    </div>

                    <div>
                        <label class="text-sm text-gray-300 block mb-1">Password</label>
                        <input type="password" id="login-password" required
                               class="w-full px-4 py-3 rounded-xl bg-white/5 border border-gray-700 text-white focus:border-cyan-500 outline-none transition-all">
                    </div>

                    <div id="login-error" class="hidden text-red-400 text-sm text-center bg-red-500/10 py-2 rounded border border-red-500/20"></div>

                    <button type="submit" id="login-btn" 
                            class="w-full py-3 bg-gradient-to-r from-pink-600 to-purple-600 hover:from-pink-500 hover:to-purple-500 text-white font-bold rounded-xl transition-all transform hover:scale-[1.02]">
                        Sign In
                    </button>

                    <div class="flex items-center justify-between text-sm text-gray-400">
                        <label class="flex items-center gap-2 cursor-pointer">
                            <input type="checkbox" class="w-4 h-4 rounded border-gray-600 bg-white/5">
                            <span>Remember me</span>
                        </label>
                        <a href="#" class="text-pink-400 hover:text-pink-300">Forgot password?</a>
                    </div>

                    <p class="text-center text-gray-400 text-sm">
                        Don't have an account? 
                        <button type="button" onclick="toggleAuthMode()" class="text-pink-400 hover:text-pink-300 font-semibold ml-1">
                            Sign up for free
                        </button>
                    </p>
                </form>

                <!-- Register Form -->
                <form id="register-form" class="hidden space-y-5" onsubmit="event.preventDefault(); handleRegister();">
                    <div>
                        <label class="text-sm text-gray-300 block mb-1">Username <span class="text-red-400">*</span></label>
                        <input type="text" id="reg-username" required
                               class="w-full px-4 py-3 rounded-xl bg-white/5 border border-gray-700 text-white focus:border-pink-500 outline-none transition-all">
                    </div>

                    <div>
                        <label class="text-sm text-gray-300 block mb-1">Email <span class="text-red-400">*</span></label>
                        <input type="email" id="reg-email" required
                               class="w-full px-4 py-3 rounded-xl bg-white/5 border border-gray-700 text-white focus:border-pink-500 outline-none transition-all">
                    </div>

                    <div>
                        <label class="text-sm text-gray-300 block mb-1">Password <span class="text-red-400">*</span> (min 6 chars)</label>
                        <input type="password" id="reg-password" required minlength="6"
                               class="w-full px-4 py-3 rounded-xl bg-white/5 border border-gray-700 text-white focus:border-cyan-500 outline-none transition-all">
                    </div>

                    <div>
                        <label class="text-sm text-gray-300 block mb-1">Confirm Password <span class="text-red-400">*</span></label>
                        <input type="password" id="reg-confirm" required
                               class="w-full px-4 py-3 rounded-xl bg-white/5 border border-gray-700 text-white focus:border-cyan-500 outline-none transition-all">
                    </div>

                    <div id="register-error" class="hidden text-red-400 text-sm text-center bg-red-500/10 py-2 rounded border border-red-500/20"></div>
                    
                    <div id="register-success" class="hidden text-emerald-400 text-sm text-center bg-emerald-500/10 py-3 rounded border border-emerald-500/20">
                        <div class="font-bold mb-1">‚úì Account Created!</div>
                        <div>Check your email to confirm your account.</div>
                    </div>

                    <button type="submit" id="register-btn" 
                            class="w-full py-3 bg-gradient-to-r from-cyan-600 to-blue-600 hover:from-cyan-500 hover:to-blue-500 text-white font-bold rounded-xl transition-all transform hover:scale-[1.02]">
                        Create Account
                    </button>

                    <div class="flex items-start gap-2 text-xs text-gray-500">
                        <input type="checkbox" id="terms-checkbox" required class="mt-0.5 w-4 h-4 rounded border-gray-600 bg-white/5">
                        <span>I agree to the <a href="#" class="text-pink-400 hover:underline">Terms of Service</a> and <a href="#" class="text-pink-400 hover:underline">Privacy Policy</a></span>
                    </div>

                    <p class="text-center text-gray-400 text-sm">
                        Already have an account? 
                        <button type="button" onclick="toggleAuthMode()" class="text-cyan-400 hover:text-cyan-300 font-semibold ml-1">
                            Sign in
                        </button>
                    </p>
                </form>
            </div>
        </div>
    </div>

    <!-- ==================== MAIN APP ==================== -->
    <div id="main-app" class="opacity-20 pointer-events-none transition-all duration-1000 pt-10">
        
        <!-- Navigation -->
        <nav class="fixed top-8 w-full z-40 bg-black/80 backdrop-blur-md border-b border-white/10">
            <div class="flex justify-between items-center max-w-7xl mx-auto px-4 py-3">
                <div class="flex items-center gap-3">
                    <div class="text-xl md:text-2xl font-black fontDisplay tracking-tighter">TOKYO<span class="text-pink-500">STREET</span></div>
                    <span id="mode-badge" class="hidden text-xs bg-yellow-600 text-black px-2 py-1 rounded font-bold">LOCAL</span>
                </div>
                
                <div class="hidden md:flex items-center gap-8 text-sm">
                    <a href="#products" class="text-gray-300 hover:text-white transition-colors">Shop</a>
                    <a href="#" class="text-gray-300 hover:text-white transition-colors">New Arrivals</a>
                    <a href="#" class="text-gray-300 hover:text-white transition-colors">Collections</a>
                </div>
                
                <div class="flex items-center gap-4">
                    <span id="user-display" class="hidden text-sm text-gray-400 max-w-[100px] truncate"></span>
                    
                    <!-- Cart Button -->
                    <button onclick="toggleCart()" class="relative p-2 hover:bg-white/10 rounded-lg transition-colors group">
                        <svg class="w-6 h-6 text-gray-300 group-hover:text-white transition-colors" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 11V7a4 4 0 00-8 0v4M5 9h14l1 12H4L5 9z"></path>
                        </svg>
                        <span id="cart-badge" class="cart-badge absolute -top-1 -right-1 bg-pink-500 text-white text-xs w-5 h-5 rounded-full flex items-center justify-center font-bold hidden">0</span>
                    </button>
                    
                    <button onclick="handleLogout()" class="text-red-400 hover:text-red-300 font-semibold text-sm hidden md:block">Logout</button>
                    
                    <!-- Mobile menu button -->
                    <button onclick="toggleMobileMenu()" class="md:hidden p-2 hover:bg-white/10 rounded-lg">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path>
                        </svg>
                    </button>
                </div>
            </div>
            
            <!-- Mobile Menu -->
            <div id="mobile-menu" class="hidden md:hidden border-t border-white/10 bg-black/95">
                <div class="px-4 py-3 space-y-3">
                    <a href="#products" class="block text-gray-300 hover:text-white py-2">Shop All</a>
                    <a href="#" class="block text-gray-300 hover:text-white py-2">New Arrivals</a>
                    <a href="#" class="block text-gray-300 hover:text-white py-2">Collections</a>
                    <button onclick="handleLogout()" class="w-full text-left text-red-400 hover:text-red-300 py-2 border-t border-white/10 mt-3 pt-3">Logout</button>
                </div>
            </div>
        </nav>

        <!-- Hero Section -->
        <section class="pt-32 pb-16 px-4 relative overflow-hidden">
            <div class="absolute inset-0 opacity-30">
                <div class="absolute top-0 left-1/4 w-96 h-96 bg-pink-600 rounded-full filter blur-[128px]"></div>
                <div class="absolute bottom-0 right-1/4 w-96 h-96 bg-cyan-600 rounded-full filter blur-[128px]"></div>
            </div>
            <div class="relative z-10 max-w-4xl mx-auto text-center">
                <div class="fontMono text-xs text-pink-400 tracking-widest mb-4">[ NEW COLLECTION 2025 ]</div>
                <h1 class="text-4xl md:text-6xl font-black fontDisplay mb-6 leading-tight">
                    ANIME STREETWEAR<br/>
                    <span class="gradient-text">REDEFINED</span>
                </h1>
                <p class="text-gray-400 text-lg mb-8 max-w-xl mx-auto">Premium quality apparel inspired by your favorite anime. Express your passion with style.</p>
                <a href="#products" class="inline-block bg-gradient-to-r from-pink-600 to-purple-600 hover:from-pink-500 hover:to-purple-500 text-white font-bold px-8 py-4 rounded-xl transition-all transform hover:scale-105">
                    SHOP NOW
                </a>
            </div>
        </section>

        <!-- Products Section -->
        <section id="products" class="py-16 px-4">
            <div class="max-w-7xl mx-auto">
                <div class="flex items-center justify-between mb-8">
                    <h2 class="text-2xl md:text-3xl font-bold fontDisplay">FEATURED <span class="text-pink-500">DROPS</span></h2>
                    <div class="flex gap-2">
                        <button onclick="filterProducts('all')" class="filter-btn px-4 py-2 text-sm rounded-lg bg-white/10 hover:bg-white/20 transition-colors" data-filter="all">All</button>
                        <button onclick="filterProducts('hoodie')" class="filter-btn px-4 py-2 text-sm rounded-lg hover:bg-white/10 transition-colors" data-filter="hoodie">Hoodies</button>
                        <button onclick="filterProducts('tshirt')" class="filter-btn px-4 py-2 text-sm rounded-lg hover:bg-white/10 transition-colors" data-filter="tshirt">T-Shirts</button>
                    </div>
                </div>
                
                <div id="products-grid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
                    <!-- Products will be rendered here by JavaScript -->
                </div>
            </div>
        </section>

        <!-- Features Section -->
        <section class="py-16 px-4 border-t border-white/10">
            <div class="max-w-5xl mx-auto grid grid-cols-1 md:grid-cols-3 gap-8">
                <div class="text-center p-6">
                    <div class="text-4xl mb-4">üöÄ</div>
                    <h3 class="font-bold text-lg mb-2">Fast Shipping</h3>
                    <p class="text-gray-400 text-sm">Worldwide delivery in 5-10 business days</p>
                </div>
                <div class="text-center p-6">
                    <div class="text-4xl mb-4">üíé</div>
                    <h3 class="font-bold text-lg mb-2">Premium Quality</h3>
                    <p class="text-gray-400 text-sm">High-quality materials that last</p>
                </div>
                <div class="text-center p-6">
                    <div class="text-4xl mb-4">üîí</div>
                    <h3 class="font-bold text-lg mb-2">Secure Checkout</h3>
                    <p class="text-gray-400 text-sm">Protected by Stripe encryption</p>
                </div>
            </div>
        </section>

        <!-- Footer -->
        <footer class="py-12 px-4 border-t border-white/10 bg-black/50">
            <div class="max-w-5xl mx-auto">
                <div class="flex flex-col md:flex-row justify-between items-center gap-6">
                    <div class="fontDisplay text-xl font-bold">TOKYO<span class="text-pink-500">STREET</span></div>
                    <div class="flex gap-6 text-sm text-gray-400">
                        <a href="#" class="hover:text-white transition-colors">Privacy Policy</a>
                        <a href="#" class="hover:text-white transition-colors">Terms of Service</a>
                        <a href="#" class="hover:text-white transition-colors">Contact</a>
                    </div>
                </div>
                <div class="text-center text-gray-500 text-sm mt-8">¬© 2025 Tokyo Street. All rights reserved.</div>
            </div>
        </footer>
    </div>

    <!-- ==================== CART SIDEBAR ==================== -->
    <div id="cart-overlay" class="cart-overlay fixed inset-0 bg-black/60 z-[70]" onclick="toggleCart()"></div>
    
    <div id="cart-sidebar" class="cart-sidebar fixed top-0 right-0 h-full w-full max-w-md bg-gray-950 border-l border-white/10 z-[80] flex flex-col">
        <!-- Cart Header -->
        <div class="flex items-center justify-between p-4 border-b border-white/10">
            <h2 class="text-xl font-bold fontDisplay">YOUR CART</h2>
            <button onclick="toggleCart()" class="p-2 hover:bg-white/10 rounded-lg transition-colors">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                </svg>
            </button>
        </div>
        
        <!-- Cart Items -->
        <div id="cart-items" class="flex-1 overflow-y-auto p-4 space-y-4">
            <!-- Cart items will be rendered here -->
        </div>
        
        <!-- Cart Empty State -->
        <div id="cart-empty" class="flex-1 flex flex-col items-center justify-center p-8 text-center">
            <svg class="w-16 h-16 text-gray-600 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M16 11V7a4 4 0 00-8 0v4M5 9h14l1 12H4L5 9z"></path>
            </svg>
            <p class="text-gray-400 mb-4">Your cart is empty</p>
            <button onclick="toggleCart()" class="text-pink-400 hover:text-pink-300 font-semibold">Continue Shopping</button>
        </div>
        
        <!-- Cart Footer -->
        <div id="cart-footer" class="hidden border-t border-white/10 p-4 space-y-4 bg-gray-900/50">
            <div class="flex justify-between items-center text-sm">
                <span class="text-gray-400">Subtotal</span>
                <span id="cart-subtotal" class="font-bold text-lg">$0.00</span>
            </div>
            <div class="flex justify-between items-center text-xs text-gray-500">
                <span>Shipping calculated at checkout</span>
            </div>
            <button onclick="proceedToCheckout()" id="checkout-btn" class="w-full py-4 bg-gradient-to-r from-pink-600 to-purple-600 hover:from-pink-500 hover:to-purple-500 text-white font-bold rounded-xl transition-all transform hover:scale-[1.02] flex items-center justify-center gap-2">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"></path>
                </svg>
                CHECKOUT
            </button>
            <p class="text-center text-xs text-gray-500">Secured by Stripe</p>
        </div>
    </div>

    <!-- ==================== PRODUCT QUICK VIEW MODAL ==================== -->
    <div id="product-modal" class="modal-overlay fixed inset-0 bg-black/80 z-[90] flex items-center justify-center p-4">
        <div class="modal-content bg-gray-950 rounded-2xl max-w-2xl w-full max-h-[90vh] overflow-y-auto border border-white/10">
            <div id="modal-content-inner">
                <!-- Modal content will be rendered here -->
            </div>
        </div>
    </div>

    <!-- ==================== JAVASCRIPT ==================== -->
    <script>
        // ==========================================
        // CONFIGURATION
        // ==========================================
        
        const SUPABASE_URL = 'https://ukewtbhpcsxahkocmhfm.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVrZXd0YmhwY3N4YWhrb2NtaGZtIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njk4NzUzMjksImV4cCI6MjA4NTQ1MTMyOX0.Ujnkq7pX-eA6ZLXcf2WwOd4LWrWuD4bcmb0sRJxL2QA';
        
        // STRIPE CONFIGURATION
        // Replace with your Stripe publishable key
        const STRIPE_PUBLISHABLE_KEY = 'pk_test_51SxS9vEvXdzvVm9XvsJ9ucARLlhvs9MfZ6w1ePcNZnZvFNDQoAitDHV9v4Jlwyh3TXmaFMVQ3n5N8YA8GnnlLUWn00p8IMjS9n';
        
        let supabaseClient = null;
        let stripe = null;
        let isSupabaseConnected = false;
        let isLocalMode = false;
        let currentUser = null;
        
        // ==========================================
        // PRODUCT DATA
        // ==========================================
        
        const PRODUCTS = [
            {
                id: 'prod_001',
                name: 'Akatsuki Cloud Hoodie',
                price: 79.99,
                category: 'hoodie',
                image: 'https://images.unsplash.com/photo-1556821840-3a63f95609a7?w=400&h=500&fit=crop',
                description: 'Premium heavyweight hoodie featuring the iconic Akatsuki cloud pattern. Made from 100% organic cotton.',
                sizes: ['S', 'M', 'L', 'XL', 'XXL'],
                stock: { S: 5, M: 10, L: 8, XL: 3, XXL: 2 }
            },
            {
                id: 'prod_002',
                name: 'Demon Slayer Corps Tee',
                price: 39.99,
                category: 'tshirt',
                image: 'https://images.unsplash.com/photo-1583743814966-8936f5b7be1a?w=400&h=500&fit=crop',
                description: 'Classic fit t-shirt with Demon Slayer Corps emblem. Soft breathable fabric for all-day comfort.',
                sizes: ['S', 'M', 'L', 'XL'],
                stock: { S: 12, M: 15, L: 10, XL: 8 }
            },
            {
                id: 'prod_003',
                name: 'Jujutsu Kaisen Oversized Hoodie',
                price: 89.99,
                category: 'hoodie',
                image: 'https://images.unsplash.com/photo-1620799140408-edc6dcb6d633?w=400&h=500&fit=crop',
                description: 'Oversized streetwear hoodie with cursed energy graphics. Features kangaroo pocket and ribbed cuffs.',
                sizes: ['M', 'L', 'XL', 'XXL'],
                stock: { M: 6, L: 4, XL: 7, XXL: 5 }
            },
            {
                id: 'prod_004',
                name: 'Attack on Titan Survey Corps Tee',
                price: 44.99,
                category: 'tshirt',
                image: 'https://images.unsplash.com/photo-1521572163474-6864f9cf17ab?w=400&h=500&fit=crop',
                description: 'Premium cotton tee with Survey Corps wings emblem. Perfect for dedicated scouts.',
                sizes: ['S', 'M', 'L', 'XL', 'XXL'],
                stock: { S: 8, M: 12, L: 15, XL: 10, XXL: 6 }
            },
            {
                id: 'prod_005',
                name: 'One Piece Straw Hat Hoodie',
                price: 74.99,
                category: 'hoodie',
                image: 'https://images.unsplash.com/photo-1578587018452-892bacefd3f2?w=400&h=500&fit=crop',
                description: 'Sail the Grand Line in style with this Straw Hat crew hoodie. Features embroidered Jolly Roger.',
                sizes: ['S', 'M', 'L', 'XL'],
                stock: { S: 4, M: 9, L: 11, XL: 7 }
            },
            {
                id: 'prod_006',
                name: 'Chainsaw Man Power Tee',
                price: 42.99,
                category: 'tshirt',
                image: 'https://images.unsplash.com/photo-1618354691373-d851c5c3a990?w=400&h=500&fit=crop',
                description: 'Limited edition graphic tee featuring Blood Fiend artwork. Relaxed fit with dropped shoulders.',
                sizes: ['S', 'M', 'L', 'XL'],
                stock: { S: 3, M: 7, L: 5, XL: 4 }
            },
            {
                id: 'prod_007',
                name: 'Spy x Family Zip Hoodie',
                price: 84.99,
                category: 'hoodie',
                image: 'https://images.unsplash.com/photo-1614495039153-e9cd13240469?w=400&h=500&fit=crop',
                description: 'Full-zip hoodie with Forger family crest. Premium fleece lining for ultimate comfort.',
                sizes: ['S', 'M', 'L', 'XL', 'XXL'],
                stock: { S: 6, M: 8, L: 10, XL: 5, XXL: 3 }
            },
            {
                id: 'prod_008',
                name: 'My Hero Academia Plus Ultra Tee',
                price: 38.99,
                category: 'tshirt',
                image: 'https://images.unsplash.com/photo-1562157873-818bc0726f68?w=400&h=500&fit=crop',
                description: 'Go beyond with this UA High School training tee. Moisture-wicking fabric for hero training.',
                sizes: ['S', 'M', 'L', 'XL'],
                stock: { S: 10, M: 14, L: 12, XL: 9 }
            }
        ];
        
        // ==========================================
        // CART STATE
        // ==========================================
        
        let cart = [];
        
        function loadCart() {
            const savedCart = localStorage.getItem('tokyo_street_cart');
            if (savedCart) {
                cart = JSON.parse(savedCart);
            }
            updateCartUI();
        }
        
        function saveCart() {
            localStorage.setItem('tokyo_street_cart', JSON.stringify(cart));
            updateCartUI();
        }
        
        // ==========================================
        // ORDERS STATE
        // ==========================================
        
        let orders = [];
        
        function loadOrders() {
            const savedOrders = localStorage.getItem('tokyo_street_orders');
            if (savedOrders) {
                orders = JSON.parse(savedOrders);
            }
        }
        
        function saveOrders() {
            localStorage.setItem('tokyo_street_orders', JSON.stringify(orders));
        }
        
        function createOrder(cartItems, total) {
            const order = {
                id: 'TS-' + Date.now().toString().slice(-6),
                items: cartItems.map(item => {
                    const product = PRODUCTS.find(p => p.id === item.productId);
                    return {
                        ...item,
                        name: product?.name || 'Unknown Product',
                        image: product?.image || ''
                    };
                }),
                total: total,
                status: 'processing',
                createdAt: new Date().toISOString()
            };
            
            orders.unshift(order);
            saveOrders();
            
            return order;
        }
        
        // ==========================================
        // INITIALIZATION
        // ==========================================
        
        window.addEventListener('load', async function() {
            // Initialize Stripe first (doesn't depend on anything)
            initializeStripe();
            
            // Load cart from localStorage
            loadCart();
            loadOrders();
            
            // Render products
            renderProducts();
            
            // Initialize auth last (async)
            await initializeAuth();
            
            // Check URL params for payment success/cancel
            checkUrlParams();
        });
        
        function checkUrlParams() {
            const params = new URLSearchParams(window.location.search);
            
            if (params.get('success') === 'true') {
                // Payment successful - show confirmation
                const total = getCartTotal();
                if (cart.length > 0) {
                    const order = createOrder(cart, total);
                    clearCart();
                    showOrderConfirmation(order);
                }
                // Clean up URL
                window.history.replaceState({}, document.title, window.location.pathname);
            } else if (params.get('canceled') === 'true') {
                showToast('Payment was canceled. Your cart is still saved.', 'info');
                window.history.replaceState({}, document.title, window.location.pathname);
            }
        }
        
        async function initializeAuth(retryCount = 0) {
            const MAX_RETRIES = 2;
            
            // Check if Supabase library loaded
            if (typeof supabase === 'undefined' || typeof supabase.createClient !== 'function') {
                console.error('Supabase library not loaded properly');
                enableLocalMode();
                return;
            }
            
            try {
                // Create client if not already created
                if (!supabaseClient) {
                    supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
                }
                
                // Small delay to ensure Supabase is ready
                await new Promise(resolve => setTimeout(resolve, 200));
                
                // Try to get session
                const { data, error } = await supabaseClient.auth.getSession();
                
                if (error) throw error;
                
                // SUCCESS! Set connected state
                isSupabaseConnected = true;
                isLocalMode = false;  // Make sure this is false
                
                // Update UI
                updateStatus('online', 'CONNECTED');
                document.getElementById('connection-banner').classList.add('hidden');
                document.getElementById('mode-badge').classList.add('hidden');
                
                // Check if user is logged in
                const { data: { user } } = await supabaseClient.auth.getUser();
                if (user) {
                    currentUser = user;
                    enterApp(user);
                }
                
                console.log('Supabase connected successfully');
                
            } catch (err) {
                console.error('Connection attempt ' + (retryCount + 1) + ' failed:', err.message || err);
                
                // Retry if we haven't exceeded max retries
                if (retryCount < MAX_RETRIES) {
                    console.log('Retrying connection in 1 second...');
                    await new Promise(resolve => setTimeout(resolve, 1000));
                    return initializeAuth(retryCount + 1);
                }
                
                console.error('All connection attempts failed, enabling local mode');
                enableLocalMode();
            }
        }
        
        function initializeStripe() {
            try {
                if (STRIPE_PUBLISHABLE_KEY && STRIPE_PUBLISHABLE_KEY.startsWith('pk_')) {
                    stripe = Stripe(STRIPE_PUBLISHABLE_KEY);
                    console.log('Stripe initialized successfully');
                } else {
                    console.log('Stripe key not configured, running in demo mode');
                }
            } catch (err) {
                console.error('Stripe initialization failed:', err);
            }
        }
        
        function enableLocalMode() {
            isLocalMode = true;
            updateStatus('local', 'LOCAL MODE');
            document.getElementById('connection-banner').classList.remove('hidden');
            document.getElementById('mode-badge').classList.remove('hidden');
            
            const localUser = localStorage.getItem('tokyo_street_user');
            if (localUser) {
                currentUser = JSON.parse(localUser);
                enterApp(currentUser);
            }
        }
        
        function updateStatus(status, text) {
            const dot = document.getElementById('status-dot');
            const label = document.getElementById('auth-status');
            
            dot.className = 'status-dot status-' + status;
            label.textContent = text;
            label.className = status === 'online' ? 'text-emerald-400' : 
                             status === 'local' ? 'text-yellow-400' : 'text-red-400';
        }
        
        // ==========================================
        // PRODUCT RENDERING
        // ==========================================
        
        function renderProducts(filter = 'all') {
            const grid = document.getElementById('products-grid');
            const filteredProducts = filter === 'all' 
                ? PRODUCTS 
                : PRODUCTS.filter(p => p.category === filter);
            
            grid.innerHTML = filteredProducts.map(product => `
                <div class="product-card rounded-xl overflow-hidden" data-category="${product.category}">
                    <div class="relative overflow-hidden aspect-[4/5] bg-gray-900">
                        <img src="${product.image}" alt="${product.name}" 
                             class="product-image w-full h-full object-cover" 
                             loading="lazy">
                        <button onclick="openQuickView('${product.id}')" 
                                class="absolute bottom-4 left-4 right-4 py-2 bg-black/80 hover:bg-black text-white text-sm font-semibold rounded-lg opacity-0 translate-y-4 transition-all duration-300 group-hover:opacity-100 group-hover:translate-y-0"
                                style="opacity: 0;">
                            Quick View
                        </button>
                    </div>
                    <div class="p-4">
                        <div class="flex justify-between items-start mb-2">
                            <h3 class="font-bold text-sm leading-tight">${product.name}</h3>
                            <span class="text-pink-400 font-bold fontMono">$${product.price.toFixed(2)}</span>
                        </div>
                        <p class="text-gray-500 text-xs mb-3">${product.category.toUpperCase()}</p>
                        <button onclick="openQuickView('${product.id}')" 
                                class="w-full py-2 bg-white/10 hover:bg-pink-600 text-sm font-semibold rounded-lg transition-all duration-300">
                            Add to Cart
                        </button>
                    </div>
                </div>
            `).join('');
            
            // Add hover effect to show quick view button
            document.querySelectorAll('.product-card').forEach(card => {
                const btn = card.querySelector('button');
                card.addEventListener('mouseenter', () => {
                    btn.style.opacity = '1';
                    btn.style.transform = 'translateY(0)';
                });
                card.addEventListener('mouseleave', () => {
                    btn.style.opacity = '0';
                    btn.style.transform = 'translateY(1rem)';
                });
            });
        }
        
        function filterProducts(filter) {
            // Update button styles
            document.querySelectorAll('.filter-btn').forEach(btn => {
                if (btn.dataset.filter === filter) {
                    btn.classList.add('bg-white/10');
                } else {
                    btn.classList.remove('bg-white/10');
                }
            });
            renderProducts(filter);
        }
        
        // ==========================================
        // QUICK VIEW MODAL
        // ==========================================
        
        function openQuickView(productId) {
            const product = PRODUCTS.find(p => p.id === productId);
            if (!product) return;
            
            const modal = document.getElementById('product-modal');
            const content = document.getElementById('modal-content-inner');
            
            content.innerHTML = `
                <div class="relative">
                    <button onclick="closeQuickView()" class="absolute top-4 right-4 z-10 p-2 bg-black/50 hover:bg-black rounded-full transition-colors">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                    <div class="grid md:grid-cols-2 gap-6">
                        <div class="aspect-square bg-gray-900 rounded-xl overflow-hidden">
                            <img src="${product.image}" alt="${product.name}" class="w-full h-full object-cover">
                        </div>
                        <div class="p-6 flex flex-col">
                            <div class="text-xs text-pink-400 fontMono mb-2">${product.category.toUpperCase()}</div>
                            <h2 class="text-2xl font-bold mb-2">${product.name}</h2>
                            <p class="text-3xl font-bold text-pink-400 fontMono mb-4">$${product.price.toFixed(2)}</p>
                            <p class="text-gray-400 text-sm mb-6">${product.description}</p>
                            
                            <div class="mb-6">
                                <label class="text-sm text-gray-300 mb-2 block">Select Size</label>
                                <div class="flex flex-wrap gap-2" id="size-selector">
                                    ${product.sizes.map(size => `
                                        <button onclick="selectSize('${size}')" 
                                                class="size-btn px-4 py-2 border border-white/20 rounded-lg text-sm font-semibold ${product.stock[size] === 0 ? 'opacity-30 cursor-not-allowed' : ''}"
                                                data-size="${size}"
                                                ${product.stock[size] === 0 ? 'disabled' : ''}>
                                            ${size}
                                            ${product.stock[size] <= 3 && product.stock[size] > 0 ? '<span class="text-xs text-yellow-400 ml-1">Low</span>' : ''}
                                        </button>
                                    `).join('')}
                                </div>
                                <p id="size-error" class="hidden text-red-400 text-xs mt-2">Please select a size</p>
                            </div>
                            
                            <div class="mt-auto space-y-3">
                                <button onclick="addToCartFromModal('${product.id}')" 
                                        class="w-full py-4 bg-gradient-to-r from-pink-600 to-purple-600 hover:from-pink-500 hover:to-purple-500 text-white font-bold rounded-xl transition-all transform hover:scale-[1.02]">
                                    ADD TO CART
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            modal.classList.add('open');
            document.body.style.overflow = 'hidden';
        }
        
        function closeQuickView() {
            const modal = document.getElementById('product-modal');
            modal.classList.remove('open');
            document.body.style.overflow = '';
        }
        
        let selectedSize = null;
        
        function selectSize(size) {
            selectedSize = size;
            document.querySelectorAll('.size-btn').forEach(btn => {
                btn.classList.toggle('selected', btn.dataset.size === size);
            });
            document.getElementById('size-error').classList.add('hidden');
        }
        
        function addToCartFromModal(productId) {
            if (!selectedSize) {
                document.getElementById('size-error').classList.remove('hidden');
                return;
            }
            
            addToCart(productId, selectedSize);
            selectedSize = null;
            closeQuickView();
        }
        
        // ==========================================
        // CART FUNCTIONS
        // ==========================================
        
        function addToCart(productId, size, quantity = 1) {
            const product = PRODUCTS.find(p => p.id === productId);
            if (!product) return;
            
            // Check if item already exists in cart
            const existingIndex = cart.findIndex(item => 
                item.productId === productId && item.size === size
            );
            
            if (existingIndex > -1) {
                // Check stock
                if (cart[existingIndex].quantity + quantity > product.stock[size]) {
                    showToast('Not enough stock available', 'error');
                    return;
                }
                cart[existingIndex].quantity += quantity;
            } else {
                cart.push({
                    productId,
                    size,
                    quantity,
                    price: product.price
                });
            }
            
            saveCart();
            showToast(`${product.name} (${size}) added to cart!`, 'success');
            animateCartBadge();
        }
        
        function removeFromCart(index) {
            cart.splice(index, 1);
            saveCart();
            showToast('Item removed from cart', 'info');
        }
        
        function updateCartQuantity(index, newQuantity) {
            if (newQuantity < 1) {
                removeFromCart(index);
                return;
            }
            
            const item = cart[index];
            const product = PRODUCTS.find(p => p.id === item.productId);
            
            if (newQuantity > product.stock[item.size]) {
                showToast('Not enough stock available', 'error');
                return;
            }
            
            cart[index].quantity = newQuantity;
            saveCart();
        }
        
        function clearCart() {
            cart = [];
            saveCart();
        }
        
        function getCartTotal() {
            return cart.reduce((total, item) => total + (item.price * item.quantity), 0);
        }
        
        function getCartCount() {
            return cart.reduce((count, item) => count + item.quantity, 0);
        }
        
        // ==========================================
        // CART UI
        // ==========================================
        
        function toggleCart() {
            const sidebar = document.getElementById('cart-sidebar');
            const overlay = document.getElementById('cart-overlay');
            
            sidebar.classList.toggle('open');
            overlay.classList.toggle('open');
            document.body.style.overflow = sidebar.classList.contains('open') ? 'hidden' : '';
        }
        
        function updateCartUI() {
            const badge = document.getElementById('cart-badge');
            const itemsContainer = document.getElementById('cart-items');
            const emptyState = document.getElementById('cart-empty');
            const footer = document.getElementById('cart-footer');
            const subtotal = document.getElementById('cart-subtotal');
            
            const count = getCartCount();
            const total = getCartTotal();
            
            // Update badge
            if (count > 0) {
                badge.textContent = count > 99 ? '99+' : count;
                badge.classList.remove('hidden');
            } else {
                badge.classList.add('hidden');
            }
            
            // Update cart display
            if (cart.length === 0) {
                itemsContainer.classList.add('hidden');
                emptyState.classList.remove('hidden');
                footer.classList.add('hidden');
            } else {
                itemsContainer.classList.remove('hidden');
                emptyState.classList.add('hidden');
                footer.classList.remove('hidden');
                
                itemsContainer.innerHTML = cart.map((item, index) => {
                    const product = PRODUCTS.find(p => p.id === item.productId);
                    if (!product) return '';
                    
                    return `
                        <div class="flex gap-4 p-3 bg-white/5 rounded-xl">
                            <div class="w-20 h-20 rounded-lg overflow-hidden bg-gray-800 flex-shrink-0">
                                <img src="${product.image}" alt="${product.name}" class="w-full h-full object-cover">
                            </div>
                            <div class="flex-1 min-w-0">
                                <h4 class="font-semibold text-sm truncate">${product.name}</h4>
                                <p class="text-gray-500 text-xs">Size: ${item.size}</p>
                                <p class="text-pink-400 font-bold fontMono text-sm mt-1">$${item.price.toFixed(2)}</p>
                            </div>
                            <div class="flex flex-col items-end justify-between">
                                <button onclick="removeFromCart(${index})" class="p-1 text-gray-500 hover:text-red-400 transition-colors">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                                    </svg>
                                </button>
                                <div class="flex items-center gap-2">
                                    <button onclick="updateCartQuantity(${index}, ${item.quantity - 1})" 
                                            class="qty-btn w-6 h-6 flex items-center justify-center rounded bg-white/10 text-sm"
                                            ${item.quantity <= 1 ? 'disabled' : ''}>
                                        ‚àí
                                    </button>
                                    <span class="w-6 text-center text-sm fontMono">${item.quantity}</span>
                                    <button onclick="updateCartQuantity(${index}, ${item.quantity + 1})" 
                                            class="qty-btn w-6 h-6 flex items-center justify-center rounded bg-white/10 text-sm">
                                        +
                                    </button>
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');
                
                subtotal.textContent = `$${total.toFixed(2)}`;
            }
        }
        
        function animateCartBadge() {
            const badge = document.getElementById('cart-badge');
            badge.classList.add('animate');
            setTimeout(() => badge.classList.remove('animate'), 300);
        }
        
        // ==========================================
        // CHECKOUT
        // ==========================================
        
        async function proceedToCheckout() {
            if (cart.length === 0) {
                showToast('Your cart is empty', 'error');
                return;
            }
            
            const btn = document.getElementById('checkout-btn');
            btn.disabled = true;
            btn.innerHTML = '<span class="animate-pulse">Processing...</span>';
            
            try {
                if (!stripe) {
                    // Demo mode - simulate checkout
                    await new Promise(resolve => setTimeout(resolve, 1500));
                    
                    const total = getCartTotal();
                    const order = createOrder(cart, total);
                    clearCart();
                    toggleCart();
                    showOrderConfirmation(order);
                    return;
                }
                
                // Real Stripe checkout
                const response = await fetch('/api/create-checkout-session', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        items: cart.map(item => ({
                            productId: item.productId,
                            size: item.size,
                            quantity: item.quantity
                        })),
                        userId: currentUser?.id || 'guest'
                    })
                });
                
                const { sessionId } = await response.json();
                const { error } = await stripe.redirectToCheckout({ sessionId });
                
                if (error) throw error;
                
            } catch (err) {
                console.error('Checkout error:', err);
                showToast('Checkout failed. Please try again.', 'error');
            } finally {
                btn.disabled = false;
                btn.innerHTML = `
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"></path>
                    </svg>
                    CHECKOUT
                `;
            }
        }
        
        // ==========================================
        // AUTH FUNCTIONS
        // ==========================================
        
        async function handleRegister() {
            const username = document.getElementById('reg-username').value.trim();
            const email = document.getElementById('reg-email').value.trim();
            const password = document.getElementById('reg-password').value;
            const confirmPassword = document.getElementById('reg-confirm').value;
            const btn = document.getElementById('register-btn');
            
            document.getElementById('register-error').classList.add('hidden');
            document.getElementById('register-success').classList.add('hidden');
            
            if (!username || !email || !password) {
                showError('Please fill in all fields', 'register-error');
                return;
            }
            if (password !== confirmPassword) {
                showError('Passwords do not match!', 'register-error');
                return;
            }
            if (password.length < 6) {
                showError('Password must be at least 6 characters', 'register-error');
                return;
            }
            
            btn.disabled = true;
            const originalText = btn.textContent;
            btn.textContent = 'Creating account...';
            
            try {
                if (isLocalMode || !isSupabaseConnected) {
                    const users = JSON.parse(localStorage.getItem('tokyo_street_users') || '[]');
                    
                    if (users.find(u => u.email === email)) {
                        throw new Error('Email already registered');
                    }
                    
                    const newUser = {
                        id: 'local_' + Date.now(),
                        email: email,
                        user_metadata: { username: username },
                        created_at: new Date().toISOString()
                    };
                    
                    users.push({ ...newUser, password: password });
                    localStorage.setItem('tokyo_street_users', JSON.stringify(users));
                    
                    document.getElementById('register-success').classList.remove('hidden');
                    showToast('Account created!', 'success');
                    
                } else {
                    const { data, error } = await supabaseClient.auth.signUp({
                        email: email,
                        password: password,
                        options: {
                            data: { username: username }
                        }
                    });
                    
                    if (error) throw error;
                    
                    if (data.user) {
                        if (data.session) {
                            currentUser = data.user;
                            enterApp(data.user);
                        } else {
                            document.getElementById('register-success').classList.remove('hidden');
                            showToast('Check your email to confirm!', 'success');
                        }
                    }
                }
            } catch (err) {
                showError(err.message, 'register-error');
            } finally {
                btn.disabled = false;
                btn.textContent = originalText;
            }
        }
        
        async function handleLogin() {
            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;
            const btn = document.getElementById('login-btn');
            
            document.getElementById('login-error').classList.add('hidden');
            
            if (!email || !password) {
                showError('Please enter email and password', 'login-error');
                return;
            }
            
            btn.disabled = true;
            const originalText = btn.textContent;
            btn.textContent = 'Logging in...';
            
            try {
                if (isLocalMode || !isSupabaseConnected) {
                    const users = JSON.parse(localStorage.getItem('tokyo_street_users') || '[]');
                    const user = users.find(u => u.email === email && u.password === password);
                    
                    if (!user) throw new Error('Invalid email or password');
                    
                    const sessionUser = {
                        id: user.id,
                        email: user.email,
                        user_metadata: user.user_metadata
                    };
                    localStorage.setItem('tokyo_street_user', JSON.stringify(sessionUser));
                    currentUser = sessionUser;
                    enterApp(sessionUser);
                    
                } else {
                    const { data, error } = await supabaseClient.auth.signInWithPassword({
                        email: email,
                        password: password
                    });
                    
                    if (error) throw error;
                    if (data.user) {
                        currentUser = data.user;
                        enterApp(data.user);
                    }
                }
            } catch (err) {
                showError(err.message, 'login-error');
            } finally {
                btn.disabled = false;
                btn.textContent = originalText;
            }
        }
        
        function handleLogout() {
            if (isSupabaseConnected && supabaseClient) {
                supabaseClient.auth.signOut();
            }
            localStorage.removeItem('tokyo_street_user');
            currentUser = null;
            location.reload();
        }
        
        function enterApp(user) {
            document.getElementById('auth-modal').style.display = 'none';
            document.getElementById('main-app').classList.remove('opacity-20', 'pointer-events-none');
            document.getElementById('main-app').classList.add('opacity-100');
            
            const username = user.user_metadata?.username || user.email;
            document.getElementById('user-display').textContent = username;
            document.getElementById('user-display').classList.remove('hidden');
            
            // Show admin link if user is admin
            if (isAdmin()) {
                document.getElementById('admin-link').classList.remove('hidden');
                document.getElementById('admin-link-mobile').classList.remove('hidden');
            }
            
            showToast('Welcome back, ' + username + '!', 'success');
        }
        
        function toggleAuthMode() {
            const loginForm = document.getElementById('login-form');
            const registerForm = document.getElementById('register-form');
            const title = document.getElementById('form-title');
            const subtitle = document.getElementById('form-subtitle');
            
            loginForm.classList.toggle('hidden');
            registerForm.classList.toggle('hidden');
            document.getElementById('login-error').classList.add('hidden');
            document.getElementById('register-error').classList.add('hidden');
            document.getElementById('register-success').classList.add('hidden');
            
            if (loginForm.classList.contains('hidden')) {
                title.textContent = 'Create Account';
                subtitle.textContent = 'Join the anime streetwear community.';
            } else {
                title.textContent = 'Sign In';
                subtitle.textContent = 'Welcome back! Please enter your details.';
            }
        }
        
        // ==========================================
        // UI HELPERS
        // ==========================================
        
        function toggleMobileMenu() {
            document.getElementById('mobile-menu').classList.toggle('hidden');
        }
        
        function showError(message, elementId) {
            const el = document.getElementById(elementId);
            el.textContent = message;
            el.classList.remove('hidden');
            setTimeout(() => el.classList.add('hidden'), 5000);
        }
        
        function showToast(message, type) {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            const colors = {
                success: 'border-emerald-500 text-emerald-400',
                error: 'border-red-500 text-red-400',
                info: 'border-cyan-500 text-cyan-400'
            };
            const icons = {
                success: '‚úì',
                error: '!',
                info: '‚Ñπ'
            };
            toast.className = `toast pointer-events-auto bg-black/90 border-l-4 ${colors[type]} p-4 rounded shadow-2xl flex items-center gap-3`;
            toast.innerHTML = `
                <span class="text-lg">${icons[type]}</span>
                <span class="text-sm text-white">${message}</span>
            `;
            container.appendChild(toast);
            setTimeout(() => toast.classList.add('show'), 100);
            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => toast.remove(), 400);
            }, 3000);
        }
        
        // Close modals on escape key
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                closeQuickView();
                closeOrderConfirmation();
                const cartSidebar = document.getElementById('cart-sidebar');
                if (cartSidebar.classList.contains('open')) {
                    toggleCart();
                }
            }
        });
    </script>
</body>
</html> 1})" 
                                            class="qty-btn w-6 h-6 flex items-center justify-center rounded bg-white/10 text-sm"
                                            ${item.quantity <= 1 ? 'disabled' : ''}>
                                        ‚àí
                                    </button>
                                    <span class="w-6 text-center text-sm fontMono">${item.quantity}</span>
                                    <button onclick="updateCartQuantity(${index}, ${item.quantity + 1})" 
                                            class="qty-btn w-6 h-6 flex items-center justify-center rounded bg-white/10 text-sm">
                                        +
                                    </button>
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');
                
                subtotal.textContent = `$${total.toFixed(2)}`;
            }
        }
        
        function animateCartBadge() {
            const badge = document.getElementById('cart-badge');
            badge.classList.add('animate');
            setTimeout(() => badge.classList.remove('animate'), 300);
        }
        
        // ==========================================
        // CHECKOUT
        // ==========================================
        
        async function proceedToCheckout() {
            if (cart.length === 0) {
                showToast('Your cart is empty', 'error');
                return;
            }
            
            const btn = document.getElementById('checkout-btn');
            btn.disabled = true;
            btn.innerHTML = '<span class="animate-pulse">Processing...</span>';
            
            try {
                // If Stripe is not configured, show demo mode
                if (!stripe) {
                    showToast('Demo Mode: Stripe not configured', 'info');
                    
                    // Simulate checkout process
                    await new Promise(resolve => setTimeout(resolve, 1500));
                    
                    // Show success modal
                    showCheckoutDemo();
                    return;
                }
                
                // Real Stripe checkout
                // In production, you would call your backend to create a Checkout Session
                const response = await fetch('/api/create-checkout-session', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        items: cart.map(item => ({
                            productId: item.productId,
                            size: item.size,
                            quantity: item.quantity
                        })),
                        userId: currentUser?.id || 'guest'
                    })
                });
                
                const { sessionId } = await response.json();
                
                // Redirect to Stripe Checkout
                const { error } = await stripe.redirectToCheckout({ sessionId });
                
                if (error) {
                    throw error;
                }
                
            } catch (err) {
                console.error('Checkout error:', err);
                showToast('Checkout failed. Please try again.', 'error');
            } finally {
                btn.disabled = false;
                btn.innerHTML = `
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"></path>
                    </svg>
                    CHECKOUT
                `;
            }
        }
        
        function showCheckoutDemo() {
            const total = getCartTotal();
            const modal = document.getElementById('product-modal');
            const content = document.getElementById('modal-content-inner');
            
            content.innerHTML = `
                <div class="p-8 text-center">
                    <div class="w-20 h-20 bg-gradient-to-br from-pink-500 to-purple-600 rounded-full flex items-center justify-center mx-auto mb-6">
                        <svg class="w-10 h-10 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                        </svg>
                    </div>
                    <h2 class="text-2xl font-bold mb-2">Demo Checkout</h2>
                    <p class="text-gray-400 mb-6">This is a demo. In production, this would redirect to Stripe Checkout.</p>
                    
                    <div class="bg-white/5 rounded-xl p-6 mb-6 text-left">
                        <h3 class="font-semibold mb-4">Order Summary</h3>
                        ${cart.map(item => {
                            const product = PRODUCTS.find(p => p.id === item.productId);
                            return `
                                <div class="flex justify-between text-sm py-2 border-b border-white/10">
                                    <span>${product.name} (${item.size}) √ó ${item.quantity}</span>
                                    <span class="fontMono">$${(item.price * item.quantity).toFixed(2)}</span>
                                </div>
                            `;
                        }).join('')}
                        <div class="flex justify-between font-bold mt-4 pt-2">
                            <span>Total</span>
                            <span class="text-pink-400 fontMono">$${total.toFixed(2)}</span>
                        </div>
                    </div>
                    
                    <div class="space-y-3">
                        <button onclick="completeDemo()" class="w-full py-3 bg-gradient-to-r from-emerald-600 to-teal-600 text-white font-bold rounded-xl hover:from-emerald-500 hover:to-teal-500 transition-all">
                            Complete Demo Order
                        </button>
                        <button onclick="closeQuickView()" class="w-full py-3 bg-white/10 text-white font-semibold rounded-xl hover:bg-white/20 transition-all">
                            Continue Shopping
                        </button>
                    </div>
                    
                    <p class="text-xs text-gray-500 mt-6">
                        To enable real payments, add your Stripe publishable key.
                    </p>
                </div>
            `;
            
            modal.classList.add('open');
            document.body.style.overflow = 'hidden';
        }
        
        function completeDemo() {
            clearCart();
            toggleCart();
            closeQuickView();
            showToast('Demo order completed! Thank you!', 'success');
        }
        
        // ==========================================
        // AUTH FUNCTIONS
        // ==========================================
        
        async function handleRegister() {
            const username = document.getElementById('reg-username').value.trim();
            const email = document.getElementById('reg-email').value.trim();
            const password = document.getElementById('reg-password').value;
            const confirmPassword = document.getElementById('reg-confirm').value;
            const btn = document.getElementById('register-btn');
            
            document.getElementById('register-error').classList.add('hidden');
            document.getElementById('register-success').classList.add('hidden');
            
            if (!username || !email || !password) {
                showError('Please fill in all fields', 'register-error');
                return;
            }
            if (password !== confirmPassword) {
                showError('Passwords do not match!', 'register-error');
                return;
            }
            if (password.length < 6) {
                showError('Password must be at least 6 characters', 'register-error');
                return;
            }
            
            btn.disabled = true;
            const originalText = btn.textContent;
            btn.textContent = 'Creating account...';
            
            try {
                if (isLocalMode || !isSupabaseConnected) {
                    const users = JSON.parse(localStorage.getItem('tokyo_street_users') || '[]');
                    
                    if (users.find(u => u.email === email)) {
                        throw new Error('Email already registered');
                    }
                    
                    const newUser = {
                        id: 'local_' + Date.now(),
                        email: email,
                        user_metadata: { username: username },
                        created_at: new Date().toISOString()
                    };
                    
                    users.push({ ...newUser, password: password });
                    localStorage.setItem('tokyo_street_users', JSON.stringify(users));
                    
                    document.getElementById('register-success').classList.remove('hidden');
                    showToast('Account created!', 'success');
                    
                } else {
                    const { data, error } = await supabaseClient.auth.signUp({
                        email: email,
                        password: password,
                        options: {
                            data: { username: username }
                        }
                    });
                    
                    if (error) throw error;
                    
                    if (data.user) {
                        if (data.session) {
                            currentUser = data.user;
                            enterApp(data.user);
                        } else {
                            document.getElementById('register-success').classList.remove('hidden');
                            showToast('Check your email to confirm!', 'success');
                        }
                    }
                }
            } catch (err) {
                showError(err.message, 'register-error');
            } finally {
                btn.disabled = false;
                btn.textContent = originalText;
            }
        }
        
        async function handleLogin() {
            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;
            const btn = document.getElementById('login-btn');
            
            document.getElementById('login-error').classList.add('hidden');
            
            if (!email || !password) {
                showError('Please enter email and password', 'login-error');
                return;
            }
            
            btn.disabled = true;
            const originalText = btn.textContent;
            btn.textContent = 'Logging in...';
            
            try {
                if (isLocalMode || !isSupabaseConnected) {
                    const users = JSON.parse(localStorage.getItem('tokyo_street_users') || '[]');
                    const user = users.find(u => u.email === email && u.password === password);
                    
                    if (!user) throw new Error('Invalid email or password');
                    
                    const sessionUser = {
                        id: user.id,
                        email: user.email,
                        user_metadata: user.user_metadata
                    };
                    localStorage.setItem('tokyo_street_user', JSON.stringify(sessionUser));
                    currentUser = sessionUser;
                    enterApp(sessionUser);
                    
                } else {
                    const { data, error } = await supabaseClient.auth.signInWithPassword({
                        email: email,
                        password: password
                    });
                    
                    if (error) throw error;
                    if (data.user) {
                        currentUser = data.user;
                        enterApp(data.user);
                    }
                }
            } catch (err) {
                showError(err.message, 'login-error');
            } finally {
                btn.disabled = false;
                btn.textContent = originalText;
            }
        }
        
        function handleLogout() {
            if (isSupabaseConnected && supabaseClient) {
                supabaseClient.auth.signOut();
            }
            localStorage.removeItem('tokyo_street_user');
            currentUser = null;
            location.reload();
        }
        
        function enterApp(user) {
            document.getElementById('auth-modal').style.display = 'none';
            document.getElementById('main-app').classList.remove('opacity-20', 'pointer-events-none');
            document.getElementById('main-app').classList.add('opacity-100');
            
            const username = user.user_metadata?.username || user.email;
            document.getElementById('user-display').textContent = username;
            document.getElementById('user-display').classList.remove('hidden');
            
            showToast('Welcome back, ' + username + '!', 'success');
        }
        
        function toggleAuthMode() {
            const loginForm = document.getElementById('login-form');
            const registerForm = document.getElementById('register-form');
            const title = document.getElementById('form-title');
            const subtitle = document.getElementById('form-subtitle');
            
            loginForm.classList.toggle('hidden');
            registerForm.classList.toggle('hidden');
            document.getElementById('login-error').classList.add('hidden');
            document.getElementById('register-error').classList.add('hidden');
            document.getElementById('register-success').classList.add('hidden');
            
            if (loginForm.classList.contains('hidden')) {
                title.textContent = 'Create Account';
                subtitle.textContent = 'Join the anime streetwear community.';
            } else {
                title.textContent = 'Sign In';
                subtitle.textContent = 'Welcome back! Please enter your details.';
            }
        }
        
        // ==========================================
        // UI HELPERS
        // ==========================================
        
        function toggleMobileMenu() {
            document.getElementById('mobile-menu').classList.toggle('hidden');
        }
        
        function showError(message, elementId) {
            const el = document.getElementById(elementId);
            el.textContent = message;
            el.classList.remove('hidden');
            setTimeout(() => el.classList.add('hidden'), 5000);
        }
        
        function showToast(message, type) {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            const colors = {
                success: 'border-emerald-500 text-emerald-400',
                error: 'border-red-500 text-red-400',
                info: 'border-cyan-500 text-cyan-400'
            };
            const icons = {
                success: '‚úì',
                error: '!',
                info: '‚Ñπ'
            };
            toast.className = `toast pointer-events-auto bg-black/90 border-l-4 ${colors[type]} p-4 rounded shadow-2xl flex items-center gap-3`;
            toast.innerHTML = `
                <span class="text-lg">${icons[type]}</span>
                <span class="text-sm text-white">${message}</span>
            `;
            container.appendChild(toast);
            setTimeout(() => toast.classList.add('show'), 100);
            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => toast.remove(), 400);
            }, 3000);
        }
        
        // Close modals on escape key
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                closeQuickView();
                const cartSidebar = document.getElementById('cart-sidebar');
                if (cartSidebar.classList.contains('open')) {
                    toggleCart();
                }
            }
        });
    </script>
</body>
</html>
