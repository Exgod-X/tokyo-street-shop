<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TOKYO STREET | Live Dynamic Vault</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;700;900&family=Orbitron:wght@400;700;900&family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet">
    
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <style>
        body { font-family: 'Noto Sans JP', sans-serif; background-color: #0a0a0f; color: #fff; overflow-x: hidden; }
        .fontDisplay { font-family: 'Orbitron', monospace; }
        .product-card { transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); background: linear-gradient(135deg, rgba(21,21,32,0.9) 0%, rgba(21,21,32,0.6) 100%); backdrop-filter: blur(10px); }
        .cart-sidebar { transform: translateX(100%); transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1); }
        .cart-sidebar.open { transform: translateX(0); }
        
        .status-dot { width: 8px; height: 8px; border-radius: 50%; display: inline-block; margin-right: 6px; }
        .status-online { background: #00ff41; box-shadow: 0 0 10px #00ff41; }
        .status-offline { background: #ff0033; }
        .status-local { background: #ffff00; }
        
        .toast { transform: translateX(120%); transition: transform 0.4s cubic-bezier(0.68, -0.55, 0.265, 1.55); }
        .toast.show { transform: translateX(0); }
    </style>
</head>
<body class="antialiased">

    <!-- Local Mode Indicator (shows only when Supabase fails) -->
    <div id="connection-banner" class="hidden fixed top-0 w-full z-[200] bg-yellow-600 text-black p-2 text-center text-sm font-bold">
        ‚ö†Ô∏è OFFLINE MODE: Using local storage only
        <button onclick="location.reload()" class="ml-2 bg-black text-yellow-400 px-3 py-1 rounded text-xs hover:bg-gray-800">Reconnect</button>
    </div>

    <!-- Status Bar -->
    <div class="fixed top-0 w-full z-50 bg-black/90 border-b border-white/10 px-4 py-2 flex justify-between items-center text-xs font-mono">
        <div class="flex items-center gap-4">
            <span class="flex items-center">
                <span id="status-dot" class="status-dot status-offline"></span>
                <span id="auth-status" class="text-gray-400">CONNECTING...</span>
            </span>
        </div>
        <div class="text-gray-500">TOKYO STREET SYSTEM</div>
    </div>

    <!-- Toast Container -->
    <div id="toast-container" class="fixed top-16 right-4 z-50 flex flex-col gap-2 w-80 pointer-events-none"></div>

    <!-- Auth Modal -->
    <div id="auth-modal" class="fixed inset-0 z-[100] flex overflow-hidden bg-gray-900">
        <div class="hidden lg:flex lg:w-1/2 relative overflow-hidden bg-gradient-to-br from-indigo-900 via-purple-900 to-pink-800">
            <div class="relative z-10 flex flex-col justify-center px-16 text-white">
                <h1 class="text-5xl font-bold mb-6">
                    Welcome to<br/>
                    <span class="text-transparent bg-clip-text bg-gradient-to-r from-pink-400 to-cyan-400">Tokyo Street</span>
                </h1>
                <p class="text-gray-300 text-lg">Discover exclusive anime streetwear.</p>
            </div>
        </div>

        <div class="w-full lg:w-1/2 bg-gray-950 flex flex-col justify-center px-8 relative">
            <div class="relative z-10 w-full max-w-md mx-auto">
                <div class="mb-8">
                    <h2 id="form-title" class="text-3xl font-bold text-white mb-2">Sign In</h2>
                    <p id="form-subtitle" class="text-gray-400">Welcome back! Please enter your details.</p>
                </div>

                <!-- Login Form -->
                <form id="login-form" class="space-y-6" onsubmit="event.preventDefault(); handleLogin();">
                    <div>
                        <label class="text-sm text-gray-300 block mb-1">Email</label>
                        <input type="email" id="login-email" required
                               class="w-full px-4 py-3 rounded-xl bg-white/5 border border-gray-700 text-white focus:border-pink-500 outline-none transition-all">
                    </div>

                    <div>
                        <label class="text-sm text-gray-300 block mb-1">Password</label>
                        <input type="password" id="login-password" required
                               class="w-full px-4 py-3 rounded-xl bg-white/5 border border-gray-700 text-white focus:border-cyan-500 outline-none transition-all">
                    </div>

                    <div id="login-error" class="hidden text-red-400 text-sm text-center bg-red-500/10 py-2 rounded border border-red-500/20"></div>

                    <button type="submit" id="login-btn" 
                            class="w-full py-3 bg-gradient-to-r from-pink-600 to-purple-600 hover:from-pink-500 hover:to-purple-500 text-white font-bold rounded-xl transition-all transform hover:scale-[1.02]">
                        Sign In
                    </button>

                    <div class="flex items-center justify-between text-sm text-gray-400">
                        <label class="flex items-center gap-2 cursor-pointer">
                            <input type="checkbox" class="w-4 h-4 rounded border-gray-600 bg-white/5">
                            <span>Remember me</span>
                        </label>
                        <a href="#" class="text-pink-400 hover:text-pink-300">Forgot password?</a>
                    </div>

                    <p class="text-center text-gray-400 text-sm">
                        Don't have an account? 
                        <button type="button" onclick="toggleAuthMode()" class="text-pink-400 hover:text-pink-300 font-semibold ml-1">
                            Sign up for free
                        </button>
                    </p>
                </form>

                <!-- Register Form -->
                <form id="register-form" class="hidden space-y-5" onsubmit="event.preventDefault(); handleRegister();">
                    <div>
                        <label class="text-sm text-gray-300 block mb-1">Username <span class="text-red-400">*</span></label>
                        <input type="text" id="reg-username" required
                               class="w-full px-4 py-3 rounded-xl bg-white/5 border border-gray-700 text-white focus:border-pink-500 outline-none transition-all">
                    </div>

                    <div>
                        <label class="text-sm text-gray-300 block mb-1">Email <span class="text-red-400">*</span></label>
                        <input type="email" id="reg-email" required
                               class="w-full px-4 py-3 rounded-xl bg-white/5 border border-gray-700 text-white focus:border-pink-500 outline-none transition-all">
                    </div>

                    <div>
                        <label class="text-sm text-gray-300 block mb-1">Password <span class="text-red-400">*</span> (min 6 chars)</label>
                        <input type="password" id="reg-password" required minlength="6"
                               class="w-full px-4 py-3 rounded-xl bg-white/5 border border-gray-700 text-white focus:border-cyan-500 outline-none transition-all">
                    </div>

                    <div>
                        <label class="text-sm text-gray-300 block mb-1">Confirm Password <span class="text-red-400">*</span></label>
                        <input type="password" id="reg-confirm" required
                               class="w-full px-4 py-3 rounded-xl bg-white/5 border border-gray-700 text-white focus:border-cyan-500 outline-none transition-all">
                    </div>

                    <div id="register-error" class="hidden text-red-400 text-sm text-center bg-red-500/10 py-2 rounded border border-red-500/20"></div>
                    
                    <div id="register-success" class="hidden text-emerald-400 text-sm text-center bg-emerald-500/10 py-3 rounded border border-emerald-500/20">
                        <div class="font-bold mb-1">‚úì Account Created!</div>
                        <div>Check your email to confirm your account.</div>
                    </div>

                    <button type="submit" id="register-btn" 
                            class="w-full py-3 bg-gradient-to-r from-cyan-600 to-blue-600 hover:from-cyan-500 hover:to-blue-500 text-white font-bold rounded-xl transition-all transform hover:scale-[1.02]">
                        Create Account
                    </button>

                    <div class="flex items-start gap-2 text-xs text-gray-500">
                        <input type="checkbox" id="terms-checkbox" required class="mt-0.5 w-4 h-4 rounded border-gray-600 bg-white/5">
                        <span>I agree to the <a href="#" class="text-pink-400 hover:underline">Terms of Service</a> and <a href="#" class="text-pink-400 hover:underline">Privacy Policy</a></span>
                    </div>

                    <p class="text-center text-gray-400 text-sm">
                        Already have an account? 
                        <button type="button" onclick="toggleAuthMode()" class="text-cyan-400 hover:text-cyan-300 font-semibold ml-1">
                            Sign in
                        </button>
                    </p>
                </form>
            </div>
        </div>
    </div>

    <!-- Main App -->
    <div id="main-app" class="opacity-20 pointer-events-none transition-all duration-1000 pt-16">
        <nav class="fixed top-8 w-full z-40 bg-black/80 backdrop-blur-md border-b border-white/10 p-4">
            <div class="flex justify-between items-center max-w-7xl mx-auto">
                <div class="flex items-center gap-3">
                    <div class="text-2xl font-black fontDisplay tracking-tighter">TOKYO STREET</div>
                    <span id="mode-badge" class="hidden text-xs bg-yellow-600 text-black px-2 py-1 rounded font-bold">LOCAL MODE</span>
                </div>
                <div class="flex items-center gap-4">
                    <span id="user-display" class="text-sm text-gray-400 hidden"></span>
                    <button onclick="handleLogout()" class="text-red-400 hover:text-red-300 font-semibold text-sm">Logout</button>
                </div>
            </div>
        </nav>
        
        <div class="pt-32 p-8 text-center min-h-screen">
            <h1 class="text-4xl font-bold mb-4 fontDisplay">Welcome to the Store!</h1>
            <p class="text-gray-400 mb-8">You are logged in successfully.</p>
            
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 max-w-4xl mx-auto">
                <div class="p-6 bg-gray-900 rounded-xl border border-white/10 hover:border-cyan-500/50 transition-colors">
                    <div class="text-3xl mb-2">üëï</div>
                    <h3 class="font-bold mb-2">Anime Hoodies</h3>
                    <p class="text-sm text-gray-400">Premium quality streetwear</p>
                </div>
                <div class="p-6 bg-gray-900 rounded-xl border border-white/10 hover:border-cyan-500/50 transition-colors">
                    <div class="text-3xl mb-2">‚ö°</div>
                    <h3 class="font-bold mb-2">Fast Shipping</h3>
                    <p class="text-sm text-gray-400">Worldwide delivery</p>
                </div>
                <div class="p-6 bg-gray-900 rounded-xl border border-white/10 hover:border-cyan-500/50 transition-colors">
                    <div class="text-3xl mb-2">üîí</div>
                    <h3 class="font-bold mb-2">Secure</h3>
                    <p class="text-sm text-gray-400">Protected checkout</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ==========================================
        // CONFIGURATION
        // ==========================================
        
        const SUPABASE_URL = 'https://ukewtbhpcsxahkocmhfm.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVrZXd0YmhwY3N4YWhrb2NtaGZtIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njk4NzUzMjksImV4cCI6MjA4NTQ1MTMyOX0.Ujnkq7pX-eA6ZLXcf2WwOd4LWrWuD4bcmb0sRJxL2QA';
        
        let supabaseClient = null;
        let isSupabaseConnected = false;
        let isLocalMode = false;
        
        // ==========================================
        // INITIALIZATION
        // ==========================================
        
        window.addEventListener('load', async function() {
            await initializeAuth();
        });
        
        async function initializeAuth() {
            if (typeof supabase === 'undefined') {
                console.error('Supabase library not loaded');
                enableLocalMode();
                return;
            }
            
            try {
                supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
                const { data, error } = await supabaseClient.auth.getSession();
                
                if (error) throw error;
                
                isSupabaseConnected = true;
                updateStatus('online', 'CONNECTED');
                
                const { data: { user } } = await supabaseClient.auth.getUser();
                if (user) enterApp(user);
                
            } catch (err) {
                console.error('Connection failed:', err);
                enableLocalMode();
            }
        }
        
        function enableLocalMode() {
            isLocalMode = true;
            updateStatus('local', 'LOCAL MODE');
            document.getElementById('connection-banner').classList.remove('hidden');
            document.getElementById('mode-badge').classList.remove('hidden');
            
            const localUser = localStorage.getItem('tokyo_street_user');
            if (localUser) enterApp(JSON.parse(localUser));
        }
        
        function updateStatus(status, text) {
            const dot = document.getElementById('status-dot');
            const label = document.getElementById('auth-status');
            
            dot.className = 'status-dot status-' + status;
            label.textContent = text;
            label.className = status === 'online' ? 'text-emerald-400' : 
                             status === 'local' ? 'text-yellow-400' : 'text-red-400';
        }
        
        // ==========================================
        // AUTHENTICATION FUNCTIONS
        // ==========================================
        
        async function handleRegister() {
            const username = document.getElementById('reg-username').value.trim();
            const email = document.getElementById('reg-email').value.trim();
            const password = document.getElementById('reg-password').value;
            const confirmPassword = document.getElementById('reg-confirm').value;
            const btn = document.getElementById('register-btn');
            
            document.getElementById('register-error').classList.add('hidden');
            document.getElementById('register-success').classList.add('hidden');
            
            if (!username || !email || !password) {
                showError('Please fill in all fields', 'register-error');
                return;
            }
            if (password !== confirmPassword) {
                showError('Passwords do not match!', 'register-error');
                return;
            }
            if (password.length < 6) {
                showError('Password must be at least 6 characters', 'register-error');
                return;
            }
            
            btn.disabled = true;
            const originalText = btn.textContent;
            btn.textContent = 'Creating account...';
            
            try {
                if (isLocalMode || !isSupabaseConnected) {
                    // Local Storage Mode
                    const users = JSON.parse(localStorage.getItem('tokyo_street_users') || '[]');
                    
                    if (users.find(u => u.email === email)) {
                        throw new Error('Email already registered');
                    }
                    
                    const newUser = {
                        id: 'local_' + Date.now(),
                        email: email,
                        user_metadata: { username: username },
                        created_at: new Date().toISOString()
                    };
                    
                    users.push({ ...newUser, password: password });
                    localStorage.setItem('tokyo_street_users', JSON.stringify(users));
                    
                    document.getElementById('register-success').classList.remove('hidden');
                    showToast('Account created!', 'success');
                    
                } else {
                    // Supabase Mode
                    const { data, error } = await supabaseClient.auth.signUp({
                        email: email,
                        password: password,
                        options: {
                            data: { username: username }
                        }
                    });
                    
                    if (error) throw error;
                    
                    if (data.user) {
                        if (data.session) {
                            enterApp(data.user);
                        } else {
                            document.getElementById('register-success').classList.remove('hidden');
                            showToast('Check your email to confirm!', 'success');
                        }
                    }
                }
            } catch (err) {
                showError(err.message, 'register-error');
            } finally {
                btn.disabled = false;
                btn.textContent = originalText;
            }
        }
        
        async function handleLogin() {
            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;
            const btn = document.getElementById('login-btn');
            
            document.getElementById('login-error').classList.add('hidden');
            
            if (!email || !password) {
                showError('Please enter email and password', 'login-error');
                return;
            }
            
            btn.disabled = true;
            const originalText = btn.textContent;
            btn.textContent = 'Logging in...';
            
            try {
                if (isLocalMode || !isSupabaseConnected) {
                    const users = JSON.parse(localStorage.getItem('tokyo_street_users') || '[]');
                    const user = users.find(u => u.email === email && u.password === password);
                    
                    if (!user) throw new Error('Invalid email or password');
                    
                    const sessionUser = {
                        id: user.id,
                        email: user.email,
                        user_metadata: user.user_metadata
                    };
                    localStorage.setItem('tokyo_street_user', JSON.stringify(sessionUser));
                    
                    enterApp(sessionUser);
                    
                } else {
                    const { data, error } = await supabaseClient.auth.signInWithPassword({
                        email: email,
                        password: password
                    });
                    
                    if (error) throw error;
                    if (data.user) enterApp(data.user);
                }
            } catch (err) {
                showError(err.message, 'login-error');
            } finally {
                btn.disabled = false;
                btn.textContent = originalText;
            }
        }
        
        function handleLogout() {
            if (isSupabaseConnected && supabaseClient) {
                supabaseClient.auth.signOut();
            }
            localStorage.removeItem('tokyo_street_user');
            location.reload();
        }
        
        function enterApp(user) {
            document.getElementById('auth-modal').style.display = 'none';
            document.getElementById('main-app').classList.remove('opacity-20', 'pointer-events-none');
            document.getElementById('main-app').classList.add('opacity-100');
            
            const username = user.user_metadata?.username || user.email;
            document.getElementById('user-display').textContent = 'Welcome, ' + username;
            document.getElementById('user-display').classList.remove('hidden');
            
            showToast('Welcome back, ' + username + '!', 'success');
        }
        
        function toggleAuthMode() {
            const loginForm = document.getElementById('login-form');
            const registerForm = document.getElementById('register-form');
            const title = document.getElementById('form-title');
            const subtitle = document.getElementById('form-subtitle');
            
            loginForm.classList.toggle('hidden');
            registerForm.classList.toggle('hidden');
            document.getElementById('login-error').classList.add('hidden');
            document.getElementById('register-error').classList.add('hidden');
            document.getElementById('register-success').classList.add('hidden');
            
            if (loginForm.classList.contains('hidden')) {
                title.textContent = 'Create Account';
                subtitle.textContent = 'Join the anime streetwear community.';
            } else {
                title.textContent = 'Sign In';
                subtitle.textContent = 'Welcome back! Please enter your details.';
            }
        }
        
        function showError(message, elementId) {
            const el = document.getElementById(elementId);
            el.textContent = message;
            el.classList.remove('hidden');
            setTimeout(() => el.classList.add('hidden'), 5000);
        }
        
        function showToast(message, type) {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            const colors = {
                success: 'border-emerald-500 text-emerald-400',
                error: 'border-red-500 text-red-400',
                info: 'border-cyan-500 text-cyan-400'
            };
            toast.className = `toast pointer-events-auto bg-black/90 border-l-4 ${colors[type]} p-4 rounded shadow-2xl flex items-center gap-3 mb-2`;
            toast.innerHTML = `<span class="text-lg">${type === 'success' ? '‚úì' : type === 'error' ? '!' : '‚Ñπ'}</span><span class="text-sm text-white">${message}</span>`;
            container.appendChild(toast);
            setTimeout(() => toast.classList.add('show'), 100);
            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => toast.remove(), 400);
            }, 3000);
        }
    </script>
</body>
</html>
